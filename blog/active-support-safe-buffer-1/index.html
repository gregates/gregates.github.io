<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>Understanding ActiveSupport::SafeBuffer (part one) | gregat.es</title>
    <meta content='width=device-width' name='viewport'>
    <link href='/css/screen.css' media='screen, projection' rel='stylesheet' type='text/css'>
    <link href='//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <nav role='banner'>
  <div class='navbar-header'>
    <button class='navbar-toggle toggle' type='button'>
      <span class='icon-bar'></span>
      <span class='icon-bar'></span>
      <span class='icon-bar'></span>
    </button>
    <a class='home' href='/'>gregat.es</a>
  </div>
  <div class='nav hide' role='navigation'>
    <ul>
      <li id='nav-blog'>
        <a href='/blog'>Blog</a>
      </li>
      <li class='dropdown' id='nav-contact'>
        <a class='toggle' href='#'>
          Contact
          <b class='caret'></b>
        </a>
        <ul class='dropdown-menu hide'>
          <li>
            <a href='https://github.com/gregates' target='_blank'>
              <span class='fa fa-github-square'></span>
              github
            </a>
          </li>
          <li>
            <a href='https://twitter.com/gregates' target='_blank'>
              <span class='fa fa-twitter-square'></span>
              twitter
            </a>
          </li>
          <li>
            <a href='http://stackoverflow.com/users/1619796/gregates' target='_blank'>
              <span class='fa fa-stack-overflow'></span>
              stackoverflow
            </a>
          </li>
          <li>
            <a href='http://www.linkedin.com/pub/greg-gates/20/824/874/' target='_blank'>
              <span class='fa fa-linkedin-square'></span>
              linkedin
            </a>
          </li>
          <li>
            <a href='mailto:greg@webkite.com'>
              <span class='fa fa-envelope'></span>
              email
            </a>
          </li>
        </ul>
      </li>
      <li id='nav-cv'>
        <a href='/cv'>CV</a>
      </li>
    </ul>
  </div>
</nav>

    <div id='content'>
      <sidebar>
        <img height='718px' src='/images/sidepic-min.png'>
      </sidebar>
      <main>
        <article id="active-support-safe-buffer-1">
  <h3>Understanding ActiveSupport::SafeBuffer (part one)</h3>
  <h4 class='subtitle'>A Puzzle</h4>
  <p class='meta'>12 Nov 2013</p>
  <div class='post'>
    <p>Recently, one of my coworkers (an ex-academic-turned-developer like myself)
raised the following ruby puzzle in our group chat.</p>

<div class="highlight"><pre><code class="ruby"><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="n">p247</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="n">string_one</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">html_safe</span> <span class="o">+</span> <span class="s1">&#39;a&#39;</span>
 <span class="o">=&gt;</span> <span class="s2">&quot;aa&quot;</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="n">p247</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="n">string_two</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">html_safe</span>
 <span class="o">=&gt;</span> <span class="s2">&quot;aa&quot;</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="n">p247</span> <span class="p">:</span><span class="mo">003</span> <span class="o">&gt;</span> <span class="n">string_one</span><span class="o">.</span><span class="n">html_safe?</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="n">p247</span> <span class="p">:</span><span class="mo">004</span> <span class="o">&gt;</span> <span class="n">string_two</span><span class="o">.</span><span class="n">html_safe?</span>
 <span class="o">=&gt;</span> <span class="kp">false</span>
</code></pre></div>

<p>To an experienced ruby/rails developer, there might not even be a <em>prima facie</em>
mystery here. If you&#39;re one of those, this series of posts probably isn&#39;t for you. To anyone else, at first glance this can easily appear odd.</p>

<!--break-->

<p>We&#39;re calling <code>String#html_safe</code> and we expect that to return a <code>String</code> object
that responds to <code>html_safe?</code> with <code>true</code>. And it does!</p>

<div class="highlight"><pre><code class="ruby"><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="n">p247</span> <span class="p">:</span><span class="mo">005</span> <span class="o">&gt;</span> <span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">html_safe</span><span class="o">.</span><span class="n">is_a?</span> <span class="nb">String</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="n">p247</span> <span class="p">:</span><span class="mo">006</span> <span class="o">&gt;</span> <span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">html_safe</span><span class="o">.</span><span class="n">html_safe?</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
</code></pre></div>

<p>So there&#39;s obviously going to be some logic that decides whether the result of
concatenating two strings is <code>html_safe?</code> when one of the concatenated strings
is and the other isn&#39;t. But what possible difference could the <em>order</em> of
concatenation make for the safety of the resulting string?</p>

<p>By the way, if you&#39;re not clear on the semantics of <code>#html_safe</code>, it&#39;s intended
to indicate that we know this particular string does not contain any html tags
that need to be escaped before rendering. If the users of your dating site
application can store arbitrary text explaining why you should ask them out,
for example, they could easily write</p>

<blockquote>
<p>I&#39;m a really nice guy &lt;script src=&quot;//horrible.malware.com/ohno.js&quot;&gt;</p>
</blockquote>

<p>and if that text wasn&#39;t properly <em>escaped</em> (i.e., the <code>&lt;</code> is replaced by <code>&amp;lt;</code>) before being rendered by some poor user&#39;s browser, it would actually load the javascript from that url and execute it. Definitely not safe.</p>

<p>Also, just to be clear, if you don&#39;t send <code>#html_safe</code> to a new <code>String</code>, the
result is <em>never</em> safe &mdash; the method doesn&#39;t try to <em>decide</em> whether the string is safe, so even a perfectly innocuous string is considered unsafe
unless it&#39;s been explicitly flagged:</p>

<div class="highlight"><pre><code class="ruby"><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="n">p247</span> <span class="p">:</span><span class="mo">007</span> <span class="o">&gt;</span> <span class="s1">&#39;mostly harmless text&#39;</span><span class="o">.</span><span class="n">html_safe?</span>
 <span class="o">=&gt;</span> <span class="kp">false</span>
</code></pre></div>

<p>So that&#39;s the setup. Why in the world would we get different return values for
<code>#html_safe?</code> on the concatenated strings <code>string_one</code> and <code>string_two</code> in the
first code snippet above? The two strings are the <em>same</em>, right!?</p>

<div class="highlight"><pre><code class="ruby"><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="n">p247</span> <span class="p">:</span><span class="mo">00</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">string_one</span> <span class="o">==</span> <span class="n">string_two</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
</code></pre></div>

<p>In <a href="/blog/active-support-safe-buffer-2/">Part Two</a>, I <em>still</em> won&#39;t explain the
answer &mdash; for that you&#39;ll have to wait for <a href="/blog/active-support-safe-buffer-3/">Part Three</a>.
That&#39;s because (as should be obvious by now) these posts are aimed at a
relative novice, like I was not long ago. And so I&#39;m going to spend some time
talking about how you&#39;d go about finding the explanation for this puzzle on
your own, if you didn&#39;t have someone to explain it to you.</p>

  </div>
  &laquo;
  <a href="/blog/#active-support-safe-buffer-1">blog index</a>
</article>

      </main>
    </div>
  </body>
  <script src='/js/gregat.es.js'></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
    ga('create', 'UA-45778206-1', 'gregat.es');
    ga('send', 'pageview');
  </script>
</html>
